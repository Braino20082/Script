-- StarterGui > LocalScript
local Players = game:GetService("Players")
local UserInput = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Alte GUIs löschen
for _, v in ipairs(playerGui:GetChildren()) do
    if v.Name == "ESPMainUI" then 
        v:Destroy() 
    end
end

-- Root ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESPMainUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- Hauptframe
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 600, 0, 400)
mainFrame.Position = UDim2.new(0.5, -300, 0.5, -200)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

-- Eckenabrundung für Hauptframe
local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 12)
mainCorner.Parent = mainFrame

-- Titelleiste
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 35)
titleBar.Position = UDim2.new(0, 0, 0, 0)
titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 12)
titleCorner.Parent = titleBar

-- Fix für untere Ecken der Titelleiste
local titleFix = Instance.new("Frame")
titleFix.Size = UDim2.new(1, 0, 0, 12)
titleFix.Position = UDim2.new(0, 0, 1, -12)
titleFix.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
titleFix.BorderSizePixel = 0
titleFix.Parent = titleBar

-- Titel
local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, -70, 1, 0)
titleLabel.Position = UDim2.new(0, 10, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "ESP Menu v2.0"
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.TextSize = 16
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = titleBar

-- Minimieren Button
local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Size = UDim2.new(0, 25, 0, 25)
minimizeBtn.Position = UDim2.new(1, -60, 0, 5)
minimizeBtn.Text = "-"
minimizeBtn.Font = Enum.Font.GothamBold
minimizeBtn.TextSize = 20
minimizeBtn.BackgroundColor3 = Color3.fromRGB(255, 193, 7)
minimizeBtn.TextColor3 = Color3.fromRGB(0, 0, 0)
minimizeBtn.BorderSizePixel = 0
minimizeBtn.Parent = titleBar

local minCorner = Instance.new("UICorner")
minCorner.CornerRadius = UDim.new(0, 4)
minCorner.Parent = minimizeBtn

-- Schließen Button
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 25, 0, 25)
closeBtn.Position = UDim2.new(1, -30, 0, 5)
closeBtn.Text = "×"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 18
closeBtn.BackgroundColor3 = Color3.fromRGB(220, 53, 69)
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeBtn.BorderSizePixel = 0
closeBtn.Parent = titleBar

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 4)
closeCorner.Parent = closeBtn

-- Sidebar (Links)
local sidebar = Instance.new("Frame")
sidebar.Size = UDim2.new(0, 150, 1, -35)
sidebar.Position = UDim2.new(0, 0, 0, 35)
sidebar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
sidebar.BorderSizePixel = 0
sidebar.Parent = mainFrame

-- Content Area (Rechts)
local contentArea = Instance.new("Frame")
contentArea.Size = UDim2.new(1, -150, 1, -35)
contentArea.Position = UDim2.new(0, 150, 0, 35)
contentArea.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
contentArea.BorderSizePixel = 0
contentArea.Parent = mainFrame

-- Resize Handle
local resizeHandle = Instance.new("TextButton")
resizeHandle.Size = UDim2.new(0, 20, 0, 20)
resizeHandle.Position = UDim2.new(1, -20, 1, -20)
resizeHandle.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
resizeHandle.BorderSizePixel = 0
resizeHandle.Text = ""
resizeHandle.Parent = mainFrame

local resizeCorner = Instance.new("UICorner")
resizeCorner.CornerRadius = UDim.new(0, 4)
resizeCorner.Parent = resizeHandle

---------------------------
-- Funktionen & Variablen
---------------------------

-- Player Funktionen
local flying = false
local flySpeed = 50
local flyVelocity
local playerSpeed = 16

-- ESP Funktionen
local espEnabled = false
local nameEnabled = false
local espConnections = {}

-- Panels
local panels = {}
local currentPanel = nil

-- Fly Toggle Funktion
local function toggleFly(state)
    if state then
        if not flyVelocity then
            local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if root then
                flyVelocity = Instance.new("BodyVelocity")
                flyVelocity.MaxForce = Vector3.new(1e5, 1e5, 1e5)
                flyVelocity.Velocity = Vector3.zero
                flyVelocity.Parent = root
            end
        end
        flying = true
    else
        flying = false
        if flyVelocity then 
            flyVelocity:Destroy() 
            flyVelocity = nil 
        end
    end
end

-- ESP Update Funktionen
local function updateESP(state)
    espEnabled = state
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character then
            local root = plr.Character:FindFirstChild("HumanoidRootPart")
            if root then
                if state then
                    if not root:FindFirstChild("HitboxESP") then
                        local box = Instance.new("BoxHandleAdornment")
                        box.Name = "HitboxESP"
                        box.Size = root.Size + Vector3.new(1, 3, 1)
                        box.Adornee = root
                        box.AlwaysOnTop = true
                        box.Transparency = 0.7
                        box.Color3 = Color3.fromRGB(255, 0, 0)
                        box.Parent = root
                    end
                else
                    local esp = root:FindFirstChild("HitboxESP")
                    if esp then esp:Destroy() end
                end
            end
        end
    end
end

local function updateNames(state)
    nameEnabled = state
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("Head") then
            local head = plr.Character.Head
            if state then
                if not head:FindFirstChild("NameESP") then
                    local billboard = Instance.new("BillboardGui")
                    billboard.Name = "NameESP"
                    billboard.Size = UDim2.new(0, 200, 0, 50)
                    billboard.Adornee = head
                    billboard.AlwaysOnTop = true
                    billboard.Parent = head
                    
                    local nameLabel = Instance.new("TextLabel")
                    nameLabel.Size = UDim2.new(1, 0, 1, 0)
                    nameLabel.BackgroundTransparency = 1
                    nameLabel.Text = plr.Name
                    nameLabel.Font = Enum.Font.GothamBold
                    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
                    nameLabel.TextScaled = true
                    nameLabel.TextStrokeTransparency = 0
                    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
                    nameLabel.Parent = billboard
                end
            else
                local nameESP = head:FindFirstChild("NameESP")
                if nameESP then nameESP:Destroy() end
            end
        end
    end
end

-- Notification Funktion
local function showNotification(title, message, duration)
    StarterGui:SetCore("SendNotification", {
        Title = title or "ESP Menu",
        Text = message or "",
        Duration = duration or 3
    })
end

-- UI Helper Funktionen
local function createButton(parent, text, position, size, callback)
    local button = Instance.new("TextButton")
    button.Size = size or UDim2.new(1, -20, 0, 30)
    button.Position = position or UDim2.new(0, 10, 0, 10)
    button.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    button.BorderSizePixel = 0
    button.Text = text
    button.Font = Enum.Font.Gotham
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextSize = 14
    button.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = button
    
    if callback then
        button.MouseButton1Click:Connect(callback)
    end
    
    return button
end

local function createSlider(parent, labelText, position, minVal, maxVal, currentVal, callback)
    local sliderFrame = Instance.new("Frame")
    sliderFrame.Size = UDim2.new(1, -20, 0, 60)
    sliderFrame.Position = position
    sliderFrame.BackgroundTransparency = 1
    sliderFrame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0, 20)
    label.Position = UDim2.new(0, 0, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = labelText .. ": " .. currentVal
    label.Font = Enum.Font.Gotham
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 12
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = sliderFrame
    
    local sliderBg = Instance.new("Frame")
    sliderBg.Size = UDim2.new(1, 0, 0, 20)
    sliderBg.Position = UDim2.new(0, 0, 0, 25)
    sliderBg.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    sliderBg.BorderSizePixel = 0
    sliderBg.Parent = sliderFrame
    
    local sliderCorner = Instance.new("UICorner")
    sliderCorner.CornerRadius = UDim.new(0, 10)
    sliderCorner.Parent = sliderBg
    
    local sliderFill = Instance.new("Frame")
    sliderFill.Size = UDim2.new((currentVal - minVal) / (maxVal - minVal), 0, 1, 0)
    sliderFill.Position = UDim2.new(0, 0, 0, 0)
    sliderFill.BackgroundColor3 = Color3.fromRGB(0, 162, 255)
    sliderFill.BorderSizePixel = 0
    sliderFill.Parent = sliderBg
    
    local fillCorner = Instance.new("UICorner")
    fillCorner.CornerRadius = UDim.new(0, 10)
    fillCorner.Parent = sliderFill
    
    local dragging = false
    
    sliderBg.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
        end
    end)
    
    sliderBg.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    UserInput.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local x = math.clamp(input.Position.X - sliderBg.AbsolutePosition.X, 0, sliderBg.AbsoluteSize.X)
            local ratio = x / sliderBg.AbsoluteSize.X
            local value = math.floor(minVal + ratio * (maxVal - minVal))
            
            sliderFill.Size = UDim2.new(ratio, 0, 1, 0)
            label.Text = labelText .. ": " .. value
            
            if callback then
                callback(value)
            end
        end
    end)
    
    return sliderFrame
end

---------------------------
-- Panel Creation
---------------------------

-- Player Panel
local function createPlayerPanel()
    local panel = Instance.new("ScrollingFrame")
    panel.Size = UDim2.new(1, 0, 1, 0)
    panel.Position = UDim2.new(0, 0, 0, 0)
    panel.BackgroundTransparency = 1
    panel.ScrollBarThickness = 6
    panel.CanvasSize = UDim2.new(0, 0, 0, 300)
    panel.Visible = false
    panel.Parent = contentArea
    
    local flyBtn = createButton(panel, "Fly: OFF", UDim2.new(0, 10, 0, 10), UDim2.new(1, -20, 0, 35))
    flyBtn.MouseButton1Click:Connect(function()
        if flying then
            toggleFly(false)
            flyBtn.Text = "Fly: OFF"
            flyBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
        else
            toggleFly(true)
            flyBtn.Text = "Fly: ON"
            flyBtn.BackgroundColor3 = Color3.fromRGB(40, 167, 69)
        end
    end)
    
    local speedSlider = createSlider(panel, "Walk Speed", UDim2.new(0, 10, 0, 60), 16, 200, playerSpeed, function(value)
        playerSpeed = value
    end)
    
    local flySpeedSlider = createSlider(panel, "Fly Speed", UDim2.new(0, 10, 0, 140), 10, 200, flySpeed, function(value)
        flySpeed = value
    end)
    
    return panel
end

-- ESP Panel
local function createESPPanel()
    local panel = Instance.new("ScrollingFrame")
    panel.Size = UDim2.new(1, 0, 1, 0)
    panel.Position = UDim2.new(0, 0, 0, 0)
    panel.BackgroundTransparency = 1
    panel.ScrollBarThickness = 6
    panel.CanvasSize = UDim2.new(0, 0, 0, 200)
    panel.Visible = false
    panel.Parent = contentArea
    
    local hitboxBtn = createButton(panel, "Player Hitbox: OFF", UDim2.new(0, 10, 0, 10), UDim2.new(1, -20, 0, 35))
    hitboxBtn.MouseButton1Click:Connect(function()
        if espEnabled then
            updateESP(false)
            hitboxBtn.Text = "Player Hitbox: OFF"
            hitboxBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
        else
            updateESP(true)
            hitboxBtn.Text = "Player Hitbox: ON"
            hitboxBtn.BackgroundColor3 = Color3.fromRGB(40, 167, 69)
        end
    end)
    
    local nameBtn = createButton(panel, "Player Names: OFF", UDim2.new(0, 10, 0, 60), UDim2.new(1, -20, 0, 35))
    nameBtn.MouseButton1Click:Connect(function()
        if nameEnabled then
            updateNames(false)
            nameBtn.Text = "Player Names: OFF"
            nameBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
        else
            updateNames(true)
            nameBtn.Text = "Player Names: ON"
            nameBtn.BackgroundColor3 = Color3.fromRGB(40, 167, 69)
        end
    end)
    
    return panel
end

-- Settings Panel
local function createSettingsPanel()
    local panel = Instance.new("ScrollingFrame")
    panel.Size = UDim2.new(1, 0, 1, 0)
    panel.Position = UDim2.new(0, 0, 0, 0)
    panel.BackgroundTransparency = 1
    panel.ScrollBarThickness = 6
    panel.CanvasSize = UDim2.new(0, 0, 0, 250)
    panel.Visible = false
    panel.Parent = contentArea
    
    local resetBtn = createButton(panel, "Reset All Settings", UDim2.new(0, 10, 0, 10), UDim2.new(1, -20, 0, 35))
    resetBtn.BackgroundColor3 = Color3.fromRGB(220, 53, 69)
    resetBtn.MouseButton1Click:Connect(function()
        -- Reset alle Werte
        toggleFly(false)
        updateESP(false)
        updateNames(false)
        playerSpeed = 16
        flySpeed = 50
        showNotification("Settings", "All settings have been reset!", 3)
    end)
    
    local aboutLabel = Instance.new("TextLabel")
    aboutLabel.Size = UDim2.new(1, -20, 0, 80)
    aboutLabel.Position = UDim2.new(0, 10, 0, 60)
    aboutLabel.BackgroundTransparency = 1
    aboutLabel.Text = "ESP Menu v2.0\n\nFeatures:\n• Player ESP (Hitbox & Names)\n• Fly with custom speed\n• Custom walk speed\n• Drag & Resize window"
    aboutLabel.Font = Enum.Font.Gotham
    aboutLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    aboutLabel.TextSize = 12
    aboutLabel.TextXAlignment = Enum.TextXAlignment.Left
    aboutLabel.TextYAlignment = Enum.TextYAlignment.Top
    aboutLabel.TextWrapped = true
    aboutLabel.Parent = panel
    
    return panel
end

-- Panels erstellen
panels["Player"] = createPlayerPanel()
panels["ESP"] = createESPPanel()
panels["Settings"] = createSettingsPanel()

-- Sidebar Buttons
local buttonData = {
    {name = "Player", icon = "👤"},
    {name = "ESP", icon = "👁️"},
    {name = "Settings", icon = "⚙️"}
}

for i, data in ipairs(buttonData) do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -10, 0, 40)
    btn.Position = UDim2.new(0, 5, 0, 10 + (i-1) * 45)
    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    btn.BorderSizePixel = 0
    btn.Text = data.icon .. " " .. data.name
    btn.Font = Enum.Font.Gotham
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 14
    btn.Parent = sidebar
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = btn
    
    btn.MouseButton1Click:Connect(function()
        -- Alle Panels verstecken
        for _, panel in pairs(panels) do
            panel.Visible = false
        end
        
        -- Alle Buttons zurücksetzen
        for _, child in ipairs(sidebar:GetChildren()) do
            if child:IsA("TextButton") then
                child.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            end
        end
        
        -- Aktuelles Panel anzeigen
        panels[data.name].Visible = true
        btn.BackgroundColor3 = Color3.fromRGB(0, 162, 255)
        currentPanel = data.name
    end)
end

-- Standard Panel anzeigen
panels["Player"].Visible = true
currentPanel = "Player"

---------------------------
-- Event Handlers
---------------------------

-- Close Button
closeBtn.MouseButton1Click:Connect(function()
    screenGui:Destroy()
end)

-- Minimize Button
local minimized = false
minimizeBtn.MouseButton1Click:Connect(function()
    if minimized then
        mainFrame.Size = UDim2.new(0, 600, 0, 400)
        minimizeBtn.Text = "-"
        minimized = false
    else
        mainFrame.Size = UDim2.new(0, 600, 0, 35)
        minimizeBtn.Text = "+"
        minimized = true
    end
end)

-- Drag Functionality
local dragging = false
local dragStart = nil
local startPos = nil

titleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

UserInput.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

-- Resize Functionality
local resizing = false
local resizeStart = nil
local startSize = nil

resizeHandle.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        resizing = true
        resizeStart = input.Position
        startSize = mainFrame.Size
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                resizing = false
            end
        end)
    end
end)

UserInput.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and resizing then
        local delta = input.Position - resizeStart
        local newWidth = math.max(400, startSize.X.Offset + delta.X)
        local newHeight = math.max(300, startSize.Y.Offset + delta.Y)
        
        mainFrame.Size = UDim2.new(0, newWidth, 0, newHeight)
    end
end)

---------------------------
-- Game Logic Loops
---------------------------

-- Player Speed & Fly Loop
RunService.RenderStepped:Connect(function()
    -- Player Speed
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.WalkSpeed = playerSpeed
    end
    
    -- Fly Logic
    if flying and flyVelocity and player.Character then
        local root = player.Character:FindFirstChild("HumanoidRootPart")
        if root then
            local move = Vector3.zero
            local camera = workspace.CurrentCamera
            
            if UserInput:IsKeyDown(Enum.KeyCode.W) then 
                move = move + camera.CFrame.LookVector 
            end
            if UserInput:IsKeyDown(Enum.KeyCode.S) then 
                move = move - camera.CFrame.LookVector 
            end
            if UserInput:IsKeyDown(Enum.KeyCode.A) then 
                move = move - camera.CFrame.RightVector 
            end
            if UserInput:IsKeyDown(Enum.KeyCode.D) then 
                move = move + camera.CFrame.RightVector 
            end
            if UserInput:IsKeyDown(Enum.KeyCode.Space) then 
                move = move + Vector3.new(0, 1, 0) 
            end
            if UserInput:IsKeyDown(Enum.KeyCode.LeftShift) then 
                move = move - Vector3.new(0, 1, 0) 
            end
            
            if move.Magnitude == 0 then
                flyVelocity.Velocity = Vector3.new(0, 0, 0)
            else
                flyVelocity.Velocity = move.Unit * flySpeed
            end
        end
    end
end)

-- ESP Update für neue Spieler
Players.PlayerAdded:Connect(function(newPlayer)
    newPlayer.CharacterAdded:Connect(function()
        wait(1) -- Warten bis Character vollständig geladen ist
        if espEnabled then
            updateESP(true)
        end
        if nameEnabled then
            updateNames(true)
        end
    end)
end)

-- Initialization
showNotification("ESP Menu", "Successfully loaded ESP Menu v2.0!", 5)
print("ESP Menu v2.0 loaded successfully!")

-- Keyboard shortcut to toggle GUI (F4)
UserInput.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.F4 then
        mainFrame.Visible = not mainFrame.Visible
    end
end)
