local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInput = game:GetService("UserInputService")
local player = Players.LocalPlayer

local espEnabled = true
local nameEnabled = true
local flying = false
local flyVelocity = nil
local flySpeed = 50
local playerSpeed = 16
local jumpPower = 50

-- ESP Funktion
local function updateESP()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local root = plr.Character.HumanoidRootPart
            -- Hitbox
            if espEnabled then
                if not root:FindFirstChild("HitboxESP") then
                    local box = Instance.new("BoxHandleAdornment")
                    box.Name = "HitboxESP"
                    box.Size = Vector3.new(2, 5, 1)
                    box.Adornee = root
                    box.AlwaysOnTop = true
                    box.Transparency = 0.7
                    box.Color3 = Color3.fromRGB(255,0,0)
                    box.Parent = root
                end
            else
                local box = root:FindFirstChild("HitboxESP")
                if box then box:Destroy() end
            end

            -- Nametag
            local head = plr.Character:FindFirstChild("Head")
            if head then
                if nameEnabled then
                    if not head:FindFirstChild("NameESP") then
                        local billboard = Instance.new("BillboardGui")
                        billboard.Name = "NameESP"
                        billboard.Size = UDim2.new(0, 100, 0, 30)
                        billboard.Adornee = head
                        billboard.AlwaysOnTop = true
                        billboard.Parent = head

                        local label = Instance.new("TextLabel")
                        label.Size = UDim2.new(1,0,1,0)
                        label.BackgroundTransparency = 1
                        label.Text = plr.Name
                        label.Font = Enum.Font.GothamBold
                        label.TextScaled = true
                        label.TextStrokeTransparency = 0
                        label.TextStrokeColor3 = Color3.fromRGB(0,0,0)
                        label.TextColor3 = Color3.fromRGB(255,255,255)
                        label.Parent = billboard
                    end
                else
                    local nesp = head:FindFirstChild("NameESP")
                    if nesp then nesp:Destroy() end
                end
            end
        end
    end
end

-- Fly Funktion
local function toggleFly(state)
    if state and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        flyVelocity = Instance.new("BodyVelocity")
        flyVelocity.MaxForce = Vector3.new(1e5,1e5,1e5)
        flyVelocity.Velocity = Vector3.zero
        flyVelocity.Parent = player.Character.HumanoidRootPart
        flying = true
    else
        flying = false
        if flyVelocity then flyVelocity:Destroy(); flyVelocity=nil end
    end
end

-- WalkSpeed / JumpPower Funktion
local function applyPlayerSpeed()
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.WalkSpeed = playerSpeed
        player.Character.Humanoid.JumpPower = jumpPower
    end
end

-- RenderLoop
RunService.RenderStepped:Connect(function()
    updateESP()
    applyPlayerSpeed()
    if flying and flyVelocity and player.Character then
        local hrp = player.Character:FindFirstChild("HumanoidRootPart")
        if hrp then
            local move = Vector3.zero
            if UserInput:IsKeyDown(Enum.KeyCode.W) then move += workspace.CurrentCamera.CFrame.LookVector end
            if UserInput:IsKeyDown(Enum.KeyCode.S) then move -= workspace.CurrentCamera.CFrame.LookVector end
            if UserInput:IsKeyDown(Enum.KeyCode.A) then move -= workspace.CurrentCamera.CFrame.RightVector end
            if UserInput:IsKeyDown(Enum.KeyCode.D) then move += workspace.CurrentCamera.CFrame.RightVector end
            if UserInput:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0,1,0) end
            if UserInput:IsKeyDown(Enum.KeyCode.LeftControl) then move -= Vector3.new(0,1,0) end
            if move.Magnitude > 0 then
                flyVelocity.Velocity = move.Unit * flySpeed
            else
                flyVelocity.Velocity = Vector3.zero
            end
        end
    end
end)

-- Test Buttons in Explorer (nicht GUI)
UserInput.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.F then
        espEnabled = not espEnabled
    elseif input.KeyCode == Enum.KeyCode.N then
        nameEnabled = not nameEnabled
    elseif input.KeyCode == Enum.KeyCode.G then
        toggleFly(not flying)
    elseif input.KeyCode == Enum.KeyCode.T then
        playerSpeed +=5
        jumpPower +=5
    end
end)
