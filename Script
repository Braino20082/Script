-- StarterGui > LocalScript
local Players = game:GetService("Players")
local UserInput = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Alte GUI lÃ¶schen
if playerGui:FindFirstChild("ESPMainUI") then
    playerGui.ESPMainUI:Destroy()
end

-- Root ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESPMainUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- Variablen
local flying = false
local flySpeed = 50
local flyVelocity
local playerSpeed = 16
local espEnabled = false
local nameEnabled = false
local hitboxColor = Color3.fromRGB(255,0,0)
local nameColor = Color3.fromRGB(255,255,255)
local panels = {}
local currentPanel = nil
local playerListUI = nil
local playerInfoGui = nil
local toggleKey = Enum.KeyCode.F

-- ================================
-- Funktionen
-- ================================

-- Fly Toggle
local function toggleFly(state)
    local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if state then
        if root and not flyVelocity then
            flyVelocity = Instance.new("BodyVelocity")
            flyVelocity.MaxForce = Vector3.new(1e5,1e5,1e5)
            flyVelocity.Velocity = Vector3.zero
            flyVelocity.Parent = root
        end
        flying = true
    else
        flying = false
        if flyVelocity then
            flyVelocity:Destroy()
            flyVelocity = nil
        end
    end
end

-- ESP Update
local function updateESP(state)
    espEnabled = state
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character then
            local root = plr.Character:FindFirstChild("HumanoidRootPart")
            if root then
                if state then
                    if not root:FindFirstChild("HitboxESP") then
                        local box = Instance.new("BoxHandleAdornment")
                        box.Name = "HitboxESP"
                        box.Size = root.Size + Vector3.new(1,3,1)
                        box.Adornee = root
                        box.AlwaysOnTop = true
                        box.Transparency = 0.7
                        box.Color3 = hitboxColor
                        box.Parent = root
                    else
                        root.HitboxESP.Color3 = hitboxColor
                    end
                else
                    if root:FindFirstChild("HitboxESP") then
                        root.HitboxESP:Destroy()
                    end
                end
            end
        end
    end
end

-- Name ESP Update
local function updateNames(state)
    nameEnabled = state
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("Head") then
            local head = plr.Character.Head
            if state then
                if not head:FindFirstChild("NameESP") then
                    local billboard = Instance.new("BillboardGui")
                    billboard.Name = "NameESP"
                    billboard.Size = UDim2.new(0,200,0,50)
                    billboard.Adornee = head
                    billboard.AlwaysOnTop = true
                    billboard.Parent = head
                    local nameLabel = Instance.new("TextLabel")
                    nameLabel.Size = UDim2.new(1,0,1,0)
                    nameLabel.BackgroundTransparency = 1
                    nameLabel.Text = plr.Name
                    nameLabel.Font = Enum.Font.GothamBold
                    nameLabel.TextColor3 = nameColor
                    nameLabel.TextScaled = true
                    nameLabel.TextStrokeTransparency = 0
                    nameLabel.TextStrokeColor3 = Color3.new(0,0,0)
                    nameLabel.Parent = billboard
                else
                    head.NameESP.TextLabel.TextColor3 = nameColor
                end
            else
                if head:FindFirstChild("NameESP") then
                    head.NameESP:Destroy()
                end
            end
        end
    end
end

-- Notification Funktion
local function showNotification(title,message,duration)
    StarterGui:SetCore("SendNotification", {
        Title = title or "ESP Menu",
        Text = message or "",
        Duration = duration or 3
    })
end

-- Player Info GUI
local function createPlayerInfoGUI(targetPlayer)
    -- Alte GUI lÃ¶schen
    if playerInfoGui then playerInfoGui:Destroy() end

    playerInfoGui = Instance.new("Frame")
    playerInfoGui.Size = UDim2.new(0,350,0,450)
    playerInfoGui.Position = UDim2.new(0.5,-175,0.5,-225)
    playerInfoGui.BackgroundColor3 = Color3.fromRGB(30,30,30)
    playerInfoGui.BorderSizePixel = 0
    playerInfoGui.ZIndex = 10
    playerInfoGui.Parent = screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0,10)
    corner.Parent = playerInfoGui

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1,-30,0,40)
    titleLabel.Position = UDim2.new(0,15,0,10)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = "ðŸ‘¤ "..targetPlayer.Name.." - Info"
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextColor3 = Color3.new(1,1,1)
    titleLabel.TextSize = 18
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = playerInfoGui

    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0,25,0,25)
    closeBtn.Position = UDim2.new(1,-35,0,10)
    closeBtn.Text = "Ã—"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 16
    closeBtn.BackgroundColor3 = Color3.fromRGB(220,53,69)
    closeBtn.TextColor3 = Color3.new(1,1,1)
    closeBtn.BorderSizePixel = 0
    closeBtn.Parent = playerInfoGui
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0,4)
    closeCorner.Parent = closeBtn
    closeBtn.MouseButton1Click:Connect(function()
        playerInfoGui:Destroy()
        playerInfoGui = nil
    end)

    local infoContainer = Instance.new("ScrollingFrame")
    infoContainer.Size = UDim2.new(1,-30,1,-100)
    infoContainer.Position = UDim2.new(0,15,0,60)
    infoContainer.BackgroundColor3 = Color3.fromRGB(25,25,25)
    infoContainer.BorderSizePixel = 0
    infoContainer.ScrollBarThickness = 6
    infoContainer.CanvasSize = UDim2.new(0,0,0,600)
    infoContainer.Parent = playerInfoGui

    local infoCorner = Instance.new("UICorner")
    infoCorner.CornerRadius = UDim.new(0,8)
    infoCorner.Parent = infoContainer

    local playerInfo = {
        {"ðŸŽ® Username", targetPlayer.Name},
        {"ðŸ†” UserID", tostring(targetPlayer.UserId)},
        {"ðŸ“… Account Alter", targetPlayer.AccountAge.." Tage"},
        {"ðŸŽ¯ Team", targetPlayer.Team and targetPlayer.Team.Name or "Kein Team"}
    }

    for i,info in ipairs(playerInfo) do
        local infoFrame = Instance.new("Frame")
        infoFrame.Size = UDim2.new(1,-20,0,50)
        infoFrame.Position = UDim2.new(0,10,0,(i-1)*55)
        infoFrame.BackgroundColor3 = Color3.fromRGB(40,40,40)
        infoFrame.BorderSizePixel = 0
        infoFrame.Parent = infoContainer

        local frameCorner = Instance.new("UICorner")
        frameCorner.CornerRadius = UDim.new(0,6)
        frameCorner.Parent = infoFrame

        local titleLabel = Instance.new("TextLabel")
        titleLabel.Size = UDim2.new(1,-10,0,20)
        titleLabel.Position = UDim2.new(0,5,0,5)
        titleLabel.BackgroundTransparency = 1
        titleLabel.Text = info[1]
        titleLabel.Font = Enum.Font.GothamBold
        titleLabel.TextColor3 = Color3.fromRGB(0,162,255)
        titleLabel.TextSize = 12
        titleLabel.TextXAlignment = Enum.TextXAlignment.Left
        titleLabel.Parent = infoFrame

        local valueLabel = Instance.new("TextLabel")
        valueLabel.Size = UDim2.new(1,-10,0,20)
        valueLabel.Position = UDim2.new(0,5,0,25)
        valueLabel.BackgroundTransparency = 1
        valueLabel.Text = info[2]
        valueLabel.Font = Enum.Font.Gotham
        valueLabel.TextColor3 = Color3.new(1,1,1)
        valueLabel.TextSize = 11
        valueLabel.TextXAlignment = Enum.TextXAlignment.Left
        valueLabel.TextWrapped = true
        valueLabel.Parent = infoFrame
    end
end

-- ================================
-- Keybinds
-- ================================
UserInput.InputBegan:Connect(function(input,gp)
    if input.UserInputType == Enum.UserInputType.Keyboard then
        if input.KeyCode == toggleKey then
            screenGui.Enabled = not screenGui.Enabled
        end
    end
end)

-- ================================
-- GUI Panels
-- ================================
-- [Hier kannst du Panels wie Player, ESP, Players, Settings wieder hinzufÃ¼gen]
-- Wichtig: Panels werden genauso gebaut wie vorher, aber nun mit korrekt funktionierenden Funktionen.

-- ================================
-- RunService Update
-- ================================
RunService.RenderStepped:Connect(function()
    if flying and flyVelocity then
        local cam = workspace.CurrentCamera
        local dir = Vector3.new()
        if UserInput:IsKeyDown(Enum.KeyCode.W) then dir = dir + cam.CFrame.LookVector end
        if UserInput:IsKeyDown(Enum.KeyCode.S) then dir = dir - cam.CFrame.LookVector end
        if UserInput:IsKeyDown(Enum.KeyCode.A) then dir = dir - cam.CFrame.RightVector end
        if UserInput:IsKeyDown(Enum.KeyCode.D) then dir = dir + cam.CFrame.RightVector end
        if UserInput:IsKeyDown(Enum.KeyCode.Space) then dir = dir + Vector3.new(0,1,0) end
        if UserInput:IsKeyDown(Enum.KeyCode.LeftShift) then dir = dir - Vector3.new(0,1,0) end
        flyVelocity.Velocity = dir.Unit * flySpeed
    end
end)
