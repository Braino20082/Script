-- StarterGui > LocalScript
local Players = game:GetService("Players")
local UserInput = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Alte GUIs löschen
for _, v in ipairs(playerGui:GetChildren()) do
    if v.Name == "ESPMainUI" then 
        v:Destroy() 
    end
end

-- Root ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESPMainUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- Hauptframe
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 600, 0, 400)
mainFrame.Position = UDim2.new(0.5, -300, 0.5, -200)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

-- Eckenabrundung für Hauptframe
local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 12)
mainCorner.Parent = mainFrame

-- Titelleiste
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 35)
titleBar.Position = UDim2.new(0, 0, 0, 0)
titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 12)
titleCorner.Parent = titleBar

-- Fix für untere Ecken der Titelleiste
local titleFix = Instance.new("Frame")
titleFix.Size = UDim2.new(1, 0, 0, 12)
titleFix.Position = UDim2.new(0, 0, 1, -12)
titleFix.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
titleFix.BorderSizePixel = 0
titleFix.Parent = titleBar

-- Titel
local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, -70, 1, 0)
titleLabel.Position = UDim2.new(0, 10, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "ESP Menu v2.1"
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.TextSize = 16
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = titleBar

-- Minimieren Button
local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Size = UDim2.new(0, 25, 0, 25)
minimizeBtn.Position = UDim2.new(1, -60, 0, 5)
minimizeBtn.Text = "-"
minimizeBtn.Font = Enum.Font.GothamBold
minimizeBtn.TextSize = 20
minimizeBtn.BackgroundColor3 = Color3.fromRGB(255, 193, 7)
minimizeBtn.TextColor3 = Color3.fromRGB(0, 0, 0)
minimizeBtn.BorderSizePixel = 0
minimizeBtn.Parent = titleBar

local minCorner = Instance.new("UICorner")
minCorner.CornerRadius = UDim.new(0, 4)
minCorner.Parent = minimizeBtn

-- Schließen Button
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 25, 0, 25)
closeBtn.Position = UDim2.new(1, -30, 0, 5)
closeBtn.Text = "×"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 18
closeBtn.BackgroundColor3 = Color3.fromRGB(220, 53, 69)
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeBtn.BorderSizePixel = 0
closeBtn.Parent = titleBar

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 4)
closeCorner.Parent = closeBtn

-- Sidebar (Links)
local sidebar = Instance.new("Frame")
sidebar.Size = UDim2.new(0, 150, 1, -35)
sidebar.Position = UDim2.new(0, 0, 0, 35)
sidebar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
sidebar.BorderSizePixel = 0
sidebar.Parent = mainFrame

-- Content Area (Rechts)
local contentArea = Instance.new("Frame")
contentArea.Size = UDim2.new(1, -150, 1, -35)
contentArea.Position = UDim2.new(0, 150, 0, 35)
contentArea.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
contentArea.BorderSizePixel = 0
contentArea.Parent = mainFrame

-- Resize Handle
local resizeHandle = Instance.new("TextButton")
resizeHandle.Size = UDim2.new(0, 20, 0, 20)
resizeHandle.Position = UDim2.new(1, -20, 1, -20)
resizeHandle.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
resizeHandle.BorderSizePixel = 0
resizeHandle.Text = ""
resizeHandle.Parent = mainFrame

local resizeCorner = Instance.new("UICorner")
resizeCorner.CornerRadius = UDim.new(0, 4)
resizeCorner.Parent = resizeHandle

---------------------------
-- Funktionen & Variablen
---------------------------

-- Player Funktionen
local flying = false
local flySpeed = 50
local flyVelocity
local playerSpeed = 16

-- ESP Funktionen
local espEnabled = false
local nameEnabled = false
local espConnections = {}
local hitboxColor = Color3.fromRGB(255, 0, 0)
local nameColor = Color3.fromRGB(255, 255, 255)

-- Panels
local panels = {}
local currentPanel = nil

-- Keybind Settings
local toggleKey = Enum.KeyCode.F

-- Fly Toggle Funktion
local function toggleFly(state)
    if state then
        if not flyVelocity then
            local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if root then
                flyVelocity = Instance.new("BodyVelocity")
                flyVelocity.MaxForce = Vector3.new(1e5, 1e5, 1e5)
                flyVelocity.Velocity = Vector3.zero
                flyVelocity.Parent = root
            end
        end
        flying = true
    else
        flying = false
        if flyVelocity then 
            flyVelocity:Destroy() 
            flyVelocity = nil 
        end
    end
end

-- ESP Update Funktionen (Optimiert)
local lastESPUpdate = 0
local ESP_UPDATE_RATE = 0.1

local function updateESP(state)
    espEnabled = state
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character then
            local root = plr.Character:FindFirstChild("HumanoidRootPart")
            if root then
                if state then
                    if not root:FindFirstChild("HitboxESP") then
                        local box = Instance.new("BoxHandleAdornment")
                        box.Name = "HitboxESP"
                        box.Size = root.Size + Vector3.new(1, 3, 1)
                        box.Adornee = root
                        box.AlwaysOnTop = true
                        box.Transparency = 0.7
                        box.Color3 = hitboxColor
                        box.Parent = root
                    else
                        root.HitboxESP.Color3 = hitboxColor
                    end
                else
                    local esp = root:FindFirstChild("HitboxESP")
                    if esp then esp:Destroy() end
                end
            end
        end
    end
end

local function updateNames(state)
    nameEnabled = state
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("Head") then
            local head = plr.Character.Head
            if state then
                if not head:FindFirstChild("NameESP") then
                    local billboard = Instance.new("BillboardGui")
                    billboard.Name = "NameESP"
                    billboard.Size = UDim2.new(0, 200, 0, 50)
                    billboard.Adornee = head
                    billboard.AlwaysOnTop = true
                    billboard.Parent = head
                    
                    local nameLabel = Instance.new("TextLabel")
                    nameLabel.Size = UDim2.new(1, 0, 1, 0)
                    nameLabel.BackgroundTransparency = 1
                    nameLabel.Text = plr.Name
                    nameLabel.Font = Enum.Font.GothamBold
                    nameLabel.TextColor3 = nameColor
                    nameLabel.TextScaled = true
                    nameLabel.TextStrokeTransparency = 0
                    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
                    nameLabel.Parent = billboard
                else
                    local nameLabel = head.NameESP:FindFirstChild("TextLabel")
                    if nameLabel then
                        nameLabel.TextColor3 = nameColor
                    end
                end
            else
                local nameESP = head:FindFirstChild("NameESP")
                if nameESP then nameESP:Destroy() end
            end
        end
    end
end

-- Notification Funktion
local function showNotification(title, message, duration)
    StarterGui:SetCore("SendNotification", {
        Title = title or "ESP Menu",
        Text = message or "",
        Duration = duration or 3
    })
end

-- UI Helper Funktionen
local function createButton(parent, text, position, size, callback)
    local button = Instance.new("TextButton")
    button.Size = size or UDim2.new(1, -20, 0, 30)
    button.Position = position or UDim2.new(0, 10, 0, 10)
    button.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    button.BorderSizePixel = 0
    button.Text = text
    button.Font = Enum.Font.Gotham
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextSize = 14
    button.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = button
    
    if callback then
        button.MouseButton1Click:Connect(callback)
    end
    
    return button
end

local function createSlider(parent, labelText, position, minVal, maxVal, currentVal, callback)
    local sliderFrame = Instance.new("Frame")
    sliderFrame.Size = UDim2.new(1, -20, 0, 60)
    sliderFrame.Position = position
    sliderFrame.BackgroundTransparency = 1
    sliderFrame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0, 20)
    label.Position = UDim2.new(0, 0, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = labelText .. ": " .. currentVal
    label.Font = Enum.Font.Gotham
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 12
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = sliderFrame
    
    local sliderBg = Instance.new("Frame")
    sliderBg.Size = UDim2.new(1, 0, 0, 20)
    sliderBg.Position = UDim2.new(0, 0, 0, 25)
    sliderBg.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    sliderBg.BorderSizePixel = 0
    sliderBg.Parent = sliderFrame
    
    local sliderCorner = Instance.new("UICorner")
    sliderCorner.CornerRadius = UDim.new(0, 10)
    sliderCorner.Parent = sliderBg
    
    local sliderFill = Instance.new("Frame")
    sliderFill.Size = UDim2.new((currentVal - minVal) / (maxVal - minVal), 0, 1, 0)
    sliderFill.Position = UDim2.new(0, 0, 0, 0)
    sliderFill.BackgroundColor3 = Color3.fromRGB(0, 162, 255)
    sliderFill.BorderSizePixel = 0
    sliderFill.Parent = sliderBg
    
    local fillCorner = Instance.new("UICorner")
    fillCorner.CornerRadius = UDim.new(0, 10)
    fillCorner.Parent = sliderFill
    
    local dragging = false
    
    sliderBg.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
        end
    end)
    
    sliderBg.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    UserInput.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local x = math.clamp(input.Position.X - sliderBg.AbsolutePosition.X, 0, sliderBg.AbsoluteSize.X)
            local ratio = x / sliderBg.AbsoluteSize.X
            local value = math.floor(minVal + ratio * (maxVal - minVal))
            
            sliderFill.Size = UDim2.new(ratio, 0, 1, 0)
            label.Text = labelText .. ": " .. value
            
            if callback then
                callback(value)
            end
        end
    end)
    
    return sliderFrame
end

-- FIXED: createColorPicker mit return statement
local function createColorPicker(parent, labelText, position, currentColor, callback)
    local colorFrame = Instance.new("Frame")
    colorFrame.Size = UDim2.new(1, -20, 0, 80)
    colorFrame.Position = position
    colorFrame.BackgroundTransparency = 1
    colorFrame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0, 20)
    label.Position = UDim2.new(0, 0, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = labelText
    label.Font = Enum.Font.Gotham
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 12
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = colorFrame
    
    local colorPreview = Instance.new("Frame")
    colorPreview.Size = UDim2.new(0, 40, 0, 20)
    colorPreview.Position = UDim2.new(0, 0, 0, 25)
    colorPreview.BackgroundColor3 = currentColor
    colorPreview.BorderSizePixel = 1
    colorPreview.BorderColor3 = Color3.fromRGB(255, 255, 255)
    colorPreview.Parent = colorFrame
    
    local colorCorner = Instance.new("UICorner")
    colorCorner.CornerRadius = UDim.new(0, 4)
    colorCorner.Parent = colorPreview
    
    -- Erweiterte Farbauswahl
    local colors = {
        {Color3.fromRGB(255, 0, 0), "Red"},
        {Color3.fromRGB(0, 255, 0), "Green"}, 
        {Color3.fromRGB(0, 0, 255), "Blue"},
        {Color3.fromRGB(255, 255, 0), "Yellow"},
        {Color3.fromRGB(255, 0, 255), "Magenta"},
        {Color3.fromRGB(0, 255, 255), "Cyan"},
        {Color3.fromRGB(255, 255, 255), "White"},
        {Color3.fromRGB(255, 165, 0), "Orange"},
        {Color3.fromRGB(128, 0, 128), "Purple"},
        {Color3.fromRGB(255, 192, 203), "Pink"}
    }
    
    for i, colorData in ipairs(colors) do
        local colorBtn = Instance.new("TextButton")
        local row = math.floor((i-1) / 5)
        local col = (i-1) % 5
        
        colorBtn.Size = UDim2.new(0, 18, 0, 18)
        colorBtn.Position = UDim2.new(0, 50 + col * 22, 0, 25 + row * 22)
        colorBtn.BackgroundColor3 = colorData[1]
        colorBtn.BorderSizePixel = 1
        colorBtn.BorderColor3 = Color3.fromRGB(200, 200, 200)
        colorBtn.Text = ""
        colorBtn.Parent = colorFrame
        
        local btnCorner = Instance.new("UICorner")
        btnCorner.CornerRadius = UDim.new(0, 3)
        btnCorner.Parent = colorBtn
        
        colorBtn.MouseButton1Click:Connect(function()
            colorPreview.BackgroundColor3 = colorData[1]
            if callback then
                callback(colorData[1])
            end
        end)
    end
    
    return colorFrame -- FIXED: Das war missing!
end

---------------------------
-- Panel Creation
---------------------------

-- Player Panel
local function createPlayerPanel()
    local panel = Instance.new("ScrollingFrame")
    panel.Size = UDim2.new(1, 0, 1, 0)
    panel.Position = UDim2.new(0, 0, 0, 0)
    panel.BackgroundTransparency = 1
    panel.ScrollBarThickness = 6
    panel.CanvasSize = UDim2.new(0, 0, 0, 300)
    panel.Visible = false
    panel.Parent = contentArea
    
    local flyBtn = createButton(panel, "Fly: OFF", UDim2.new(0, 10, 0, 10), UDim2.new(1, -20, 0, 35))
    flyBtn.MouseButton1Click:Connect(function()
        if flying then
            toggleFly(false)
            flyBtn.Text = "Fly: OFF"
            flyBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
        else
            toggleFly(true)
            flyBtn.Text = "Fly: ON"
            flyBtn.BackgroundColor3 = Color3.fromRGB(40, 167, 69)
        end
    end)
    
    local speedSlider = createSlider(panel, "Walk Speed", UDim2.new(0, 10, 0, 60), 16, 200, playerSpeed, function(value)
        playerSpeed = value
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.WalkSpeed = value
        end
    end)
    
    local flySpeedSlider = createSlider(panel, "Fly Speed", UDim2.new(0, 10, 0, 140), 10, 200, flySpeed, function(value)
        flySpeed = value
    end)
    
    return panel
end

-- ESP Panel (Verbessert mit besserer Farbauswahl)
local function createESPPanel()
    local panel = Instance.new("ScrollingFrame")
    panel.Size = UDim2.new(1, 0, 1, 0)
    panel.Position = UDim2.new(0, 0, 0, 0)
    panel.BackgroundTransparency = 1
    panel.ScrollBarThickness = 6
    panel.CanvasSize = UDim2.new(0, 0, 0, 450)
    panel.Visible = false
    panel.Parent = contentArea
    
    -- Player Hitbox Toggle
    local hitboxBtn = createButton(panel, "Player Hitbox: OFF", UDim2.new(0, 10, 0, 10), UDim2.new(1, -20, 0, 35))
    hitboxBtn.MouseButton1Click:Connect(function()
        if espEnabled then
            updateESP(false)
            hitboxBtn.Text = "Player Hitbox: OFF"
            hitboxBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
        else
            updateESP(true)
            hitboxBtn.Text = "Player Hitbox: ON"
            hitboxBtn.BackgroundColor3 = Color3.fromRGB(40, 167, 69)
        end
    end)
    
    -- Hitbox Farbauswahl DIREKT unter dem Button
    local hitboxColorPicker = createColorPicker(panel, "Hitbox Farbe:", UDim2.new(0, 10, 0, 55), hitboxColor, function(newColor)
        hitboxColor = newColor
        if espEnabled then
            updateESP(true)
        end
    end)
    
    -- Player Namen Toggle
    local nameBtn = createButton(panel, "Player Names: OFF", UDim2.new(0, 10, 0, 145), UDim2.new(1, -20, 0, 35))
    nameBtn.MouseButton1Click:Connect(function()
        if nameEnabled then
            updateNames(false)
            nameBtn.Text = "Player Names: OFF"
            nameBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
        else
            updateNames(true)
            nameBtn.Text = "Player Names: ON"
            nameBtn.BackgroundColor3 = Color3.fromRGB(40, 167, 69)
        end
    end)
    
    -- Namen Farbauswahl DIREKT unter dem Button
    local nameColorPicker = createColorPicker(panel, "Namen Farbe:", UDim2.new(0, 10, 0, 190), nameColor, function(newColor)
        nameColor = newColor
        if nameEnabled then
            updateNames(true)
        end
    end)
    
    -- ESP Refresh Button
    local refreshBtn = createButton(panel, "ESP Refresh", UDim2.new(0, 10, 0, 280), UDim2.new(1, -20, 0, 35))
    refreshBtn.BackgroundColor3 = Color3.fromRGB(0, 162, 255)
    refreshBtn.MouseButton1Click:Connect(function()
        if espEnabled then updateESP(true) end
        if nameEnabled then updateNames(true) end
        showNotification("ESP", "ESP refreshed for all players!", 2)
    end)
    
    return panel
end

-- Settings Panel (Erweitert mit F-Key Toggle)
local function createSettingsPanel()
    local panel = Instance.new("ScrollingFrame")
    panel.Size = UDim2.new(1, 0, 1, 0)
    panel.Position = UDim2.new(0, 0, 0, 0)
    panel.BackgroundTransparency = 1
    panel.ScrollBarThickness = 6
    panel.CanvasSize = UDim2.new(0, 0, 0, 400)
    panel.Visible = false
    panel.Parent = contentArea
    
    -- GUI Toggle Button (F-Key Alternative)
    local guiToggleBtn = createButton(panel, "Toggle GUI (F-Key)", UDim2.new(0, 10, 0, 10), UDim2.new(1, -20, 0, 35))
    guiToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 162, 255)
    guiToggleBtn.MouseButton1Click:Connect(function()
        screenGui.Enabled = not screenGui.Enabled
        if not screenGui.Enabled then
            showNotification("ESP Menu", "GUI versteckt - Drücke F zum Anzeigen", 3)
        end
    end)
    
    -- Script Toggle Button (Komplettes Ein/Aus)
    local scriptToggleBtn = createButton(panel, "Script: AN", UDim2.new(0, 10, 0, 55), UDim2.new(1, -20, 0, 35))
    scriptToggleBtn.BackgroundColor3 = Color3.fromRGB(40, 167, 69)
    local scriptEnabled = true
    
    scriptToggleBtn.MouseButton1Click:Connect(function()
        scriptEnabled = not scriptEnabled
        if scriptEnabled then
            scriptToggleBtn.Text = "Script: AN"
            scriptToggleBtn.BackgroundColor3 = Color3.fromRGB(40, 167, 69)
            showNotification("ESP Menu", "Script aktiviert!", 2)
        else
            -- Alles ausschalten
            toggleFly(false)
            updateESP(false) 
            updateNames(false)
            scriptToggleBtn.Text = "Script: AUS"
            scriptToggleBtn.BackgroundColor3 = Color3.fromRGB(220, 53, 69)
            showNotification("ESP Menu", "Script deaktiviert!", 2)
        end
    end)
    
    -- Reset Button
    local resetBtn = createButton(panel, "Alle Einstellungen zurücksetzen", UDim2.new(0, 10, 0, 100), UDim2.new(1, -20, 0, 35))
    resetBtn.BackgroundColor3 = Color3.fromRGB(220, 53, 69)
    resetBtn.MouseButton1Click:Connect(function()
        toggleFly(false)
        updateESP(false)
        updateNames(false)
        playerSpeed = 16
        flySpeed = 50
        hitboxColor = Color3.fromRGB(255, 0, 0)
        nameColor = Color3.fromRGB(255, 255, 255)
        showNotification("Settings", "Alle Einstellungen zurückgesetzt!", 3)
    end)
    
    -- Keybind Info (Erweitert)
    local keybindInfo = Instance.new("TextLabel")
    keybindInfo.Size = UDim2.new(1, -20, 0, 80)
    keybindInfo.Position = UDim2.new(0, 10, 0, 150)
    keybindInfo.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    keybindInfo.BorderSizePixel = 0
    keybindInfo.Text = "🎮 Keybinds:\nF = GUI ein/aus\nW,A,S,D = Fly Bewegung\nSpace = Hoch fliegen\nShift = Runter fliegen"
    keybindInfo.Font = Enum.Font.Gotham
    keybindInfo.TextColor3 = Color3.fromRGB(0, 162, 255)
    keybindInfo.TextSize = 12
    keybindInfo.TextWrapped = true
    keybindInfo.TextYAlignment = Enum.TextYAlignment.Top
    keybindInfo.Parent = panel
    
    local keybindCorner = Instance.new("UICorner")
    keybindCorner.CornerRadius = UDim.new(0, 6)
    keybindCorner.Parent = keybindInfo
    
    -- About Info
    local aboutLabel = Instance.new("TextLabel")
    aboutLabel.Size = UDim2.new(1, -20, 0, 120)
    aboutLabel.Position = UDim2.new(0, 10, 0, 250)
    aboutLabel.BackgroundTransparency = 1
    aboutLabel.Text = "ESP Menu v2.1 - Verbessert\n\n✨ Neue Features:\n• F-Key Script Toggle im Settings\n• Verbesserte Farbauswahl\n• Optimierte Performance\n• ESP Refresh Button\n• Erweiterte Keybinds"
    aboutLabel.Font = Enum.Font.Gotham
    aboutLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    aboutLabel.TextSize = 11
    aboutLabel.TextXAlignment = Enum.TextXAlignment.Left
    aboutLabel.TextYAlignment = Enum.TextYAlignment.Top
    aboutLabel.TextWrapped = true
    aboutLabel.Parent = panel
    
    return panel
end

-- Panels erstellen
panels["Player"] = createPlayerPanel()
panels["ESP"] = createESPPanel()
panels["Settings"] = createSettingsPanel()

-- Sidebar Buttons
local buttonData = {
    {name = "Player", icon = "👤"},
    {name = "ESP", icon = "👁️"},
    {name = "Settings", icon = "⚙️"}
}

for i, data in ipairs(buttonData) do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -10, 0, 40)
    btn.Position = UDim2.new(0, 5, 0, 10 + (i-1) * 45)
    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    btn.BorderSizePixel = 0
    btn.Text = data.icon .. " " .. data.name
    btn.Font = Enum.Font.Gotham
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 14
    btn.Parent = sidebar
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = btn
    
    btn.MouseButton1Click:Connect(function()
        -- Alle Panels verstecken
        for _, panel in pairs(panels) do
            panel.Visible = false
        end
        
        -- Alle Buttons zurücksetzen
        for _, child in ipairs(sidebar:GetChildren()) do
            if child:IsA("TextButton") then
                child.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            end
        end
        
        -- Aktuelles Panel anzeigen
        panels[data.name].Visible = true
        btn.BackgroundColor3 = Color3.fromRGB(0, 162, 255)
        currentPanel = data.name
    end)
end

-- Standard Panel anzeigen (Player)
panels["Player"].Visible = true
for _, child in ipairs(sidebar:GetChildren()) do
    if child:IsA("TextButton") and child.Text:find("Player") then
        child.BackgroundColor3 = Color3.fromRGB(0, 162, 255)
    end
end
currentPanel = "Player"

---------------------------
-- Event Handlers
---------------------------

-- Close Button
closeBtn.MouseButton1Click:Connect(function()
    -- Cleanup vor dem Schließen
    toggleFly(false)
    updateESP(false)
    updateNames(false)
    screenGui:Destroy()
    showNotification("ESP Menu", "Script beendet!", 2)
end)

-- Minimize Button
local minimized = false
minimizeBtn.MouseButton1Click:Connect(function()
    if minimized then
        -- Expand
        local expandTween = TweenService:Create(mainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {
            Size = UDim2.new(0, 600, 0, 400)
        })
        expandTween:Play()
        minimizeBtn.Text = "-"
        minimized = false
        
        -- Show content after animation
        expandTween.Completed:Connect(function()
            sidebar.Visible = true
            contentArea.Visible = true
            resizeHandle.Visible = true
        end)
    else
        -- Minimize
        sidebar.Visible = false
        contentArea.Visible = false
        resizeHandle.Visible = false
        
        local minimizeTween = TweenService:Create(mainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {
            Size = UDim2.new(0, 600, 0, 35)
        })
        minimizeTween:Play()
        minimizeBtn.Text = "+"
        minimized = true
    end
end)

-- Drag Functionality
local dragging = false
local dragStart = nil
local startPos = nil

titleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

UserInput.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

-- Resize Functionality
local resizing = false
local resizeStart = nil
local startSize = nil

resizeHandle.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        resizing = true
        resizeStart = input.Position
        startSize = mainFrame.Size
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                resizing = false
            end
        end)
    end
end)

UserInput.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and resizing then
        local delta = input.Position - resizeStart
        local newWidth = math.max(400, startSize.X.Offset + delta.X)
        local newHeight = math.max(300, startSize.Y.Offset + delta.Y)
        
        mainFrame.Size = UDim2.new(0, newWidth, 0, newHeight)
    end
end)

---------------------------
-- Game Logic Loops (Optimiert)
---------------------------

-- Player Speed & Fly Loop
local lastSpeedUpdate = 0
local SPEED_UPDATE_RATE = 0.05

RunService.RenderStepped:Connect(function()
    local now = tick()
    
    -- Player Speed (weniger oft updaten)
    if now - lastSpeedUpdate >= SPEED_UPDATE_RATE then
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid.WalkSpeed = playerSpeed
        end
        lastSpeedUpdate = now
    end
    
    -- Fly Logic (muss smooth sein)
    if flying and flyVelocity and player.Character then
        local root = player.Character:FindFirstChild("HumanoidRootPart")
        if root then
            local move = Vector3.zero
            local camera = workspace.CurrentCamera
            
            if UserInput:IsKeyDown(Enum.KeyCode.W) then 
                move = move + camera.CFrame.LookVector 
            end
            if UserInput:IsKeyDown(Enum.KeyCode.S) then 
                move = move - camera.CFrame.LookVector 
            end
            if UserInput:IsKeyDown(Enum.KeyCode.A) then 
                move = move - camera.CFrame.RightVector 
            end
            if UserInput:IsKeyDown(Enum.KeyCode.D) then 
                move = move + camera.CFrame.RightVector 
            end
            if UserInput:IsKeyDown(Enum.KeyCode.Space) then 
                move = move + Vector3.new(0, 1, 0) 
            end
            if UserInput:IsKeyDown(Enum.KeyCode.LeftShift) then 
                move = move - Vector3.new(0, 1, 0) 
            end
            
            if move.Magnitude == 0 then
                flyVelocity.Velocity = Vector3.new(0, 0, 0)
            else
                flyVelocity.Velocity = move.Unit * flySpeed
            end
        end
    end
end)

-- ESP Update Loop (Optimiert)
RunService.Heartbeat:Connect(function()
    local now = tick()
    if now - lastESPUpdate >= ESP_UPDATE_RATE then
        if espEnabled or nameEnabled then
            -- Nur neue Spieler checken
            for _, plr in ipairs(Players:GetPlayers()) do
                if plr ~= player and plr.Character then
                    if espEnabled then
                        local root = plr.Character:FindFirstChild("HumanoidRootPart")
                        if root and not root:FindFirstChild("HitboxESP") then
                            updateESP(true)
                            break
                        end
                    end
                    
                    if nameEnabled then
                        local head = plr.Character:FindFirstChild("Head")
                        if head and not head:FindFirstChild("NameESP") then
                            updateNames(true)
                            break
                        end
                    end
                end
            end
        end
        lastESPUpdate = now
    end
end)

-- Player Events (Verbessert)
Players.PlayerAdded:Connect(function(newPlayer)
    newPlayer.CharacterAdded:Connect(function()
        wait(1) -- Warten bis Character vollständig geladen ist
        if espEnabled then
            updateESP(true)
        end
        if nameEnabled then
            updateNames(true)
        end
    end)
end)

-- Cleanup bei Player Leave
Players.PlayerRemoving:Connect(function(leavingPlayer)
    -- ESP Objekte werden automatisch mit Character entfernt
    -- Aber sicherheitshalber:
    if leavingPlayer.Character then
        local root = leavingPlayer.Character:FindFirstChild("HumanoidRootPart")
        local head = leavingPlayer.Character:FindFirstChild("Head")
        
        if root then
            local esp = root:FindFirstChild("HitboxESP")
            if esp then esp:Destroy() end
        end
        
        if head then
            local nameESP = head:FindFirstChild("NameESP")
            if nameESP then nameESP:Destroy() end
        end
    end
end)

-- Character Respawn Handler
player.CharacterAdded:Connect(function()
    -- Fly state reset bei Respawn
    flying = false
    if flyVelocity then
        flyVelocity:Destroy()
        flyVelocity = nil
    end
    
    -- Speed wieder setzen nach Respawn
    wait(1)
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.WalkSpeed = playerSpeed
    end
end)

---------------------------
-- Keyboard Shortcuts
---------------------------

-- F-Key Toggle (Erweitert)
UserInput.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed then
        if input.KeyCode == toggleKey then
            screenGui.Enabled = not screenGui.Enabled
            if screenGui.Enabled then
                showNotification("ESP Menu", "GUI sichtbar (F zum Verstecken)", 2)
            else
                showNotification("ESP Menu", "GUI versteckt (F zum Anzeigen)", 2)
            end
        end
        
        -- Extra Shortcuts (Optional)
        if input.KeyCode == Enum.KeyCode.Insert then
            -- Insert = Quick ESP Toggle
            if espEnabled then
                updateESP(false)
                showNotification("ESP", "Hitbox ESP: AUS", 1)
            else
                updateESP(true)
                showNotification("ESP", "Hitbox ESP: AN", 1)
            end
        end
        
        if input.KeyCode == Enum.KeyCode.Home then
            -- Home = Quick Name Toggle
            if nameEnabled then
                updateNames(false)
                showNotification("ESP", "Namen ESP: AUS", 1)
            else
                updateNames(true)
                showNotification("ESP", "Namen ESP: AN", 1)
            end
        end
    end
end)

---------------------------
-- Initialization & Startup
---------------------------

-- Startup Notification
wait(0.5)
showNotification("ESP Menu v2.1", "Erfolgreich geladen!\n\nF = GUI Toggle\nIns = ESP Toggle\nHome = Namen Toggle", 6)

-- Console Log
print("=== ESP Menu v2.1 Loaded ===")
print("✅ GUI Features: Drag, Resize, Minimize")
print("✅ Player Features: Fly, Speed Control")
print("✅ ESP Features: Hitbox, Names, Colors")
print("✅ Shortcuts: F, Insert, Home")
print("✅ Performance: Optimized Updates")
print("=============================")

-- Error Handler (Robustness)
local function safeCall(func, ...)
    local success, result = pcall(func, ...)
    if not success then
        warn("ESP Menu Error: " .. tostring(result))
        showNotification("Error", "Ein Fehler ist aufgetreten - Check Console", 3)
    end
    return success, result
end

-- Auto-cleanup on script end
game:GetService("RunService").Heartbeat:Connect(function()
    -- Check if GUI still exists
    if not screenGui.Parent then
        -- GUI was destroyed, cleanup
        toggleFly(false)
        updateESP(false)
        updateNames(false)
    end
end)


-- StarterGui > LocalScript
local Players = game:GetService("Players")
local UserInput = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Alte GUIs löschen
for _, v in ipairs(playerGui:GetChildren()) do
    if v.Name == "ESPMainUI" then 
        v:Destroy() 
    end
end

-- Root ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESPMainUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- Hauptframe
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 600, 0, 400)
mainFrame.Position = UDim2.new(0.5, -300, 0.5, -200)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

-- Eckenabrundung für Hauptframe
local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 12)
mainCorner.Parent = mainFrame

-- Titelleiste
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 35)
titleBar.Position = UDim2.new(0, 0, 0, 0)
titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 12)
titleCorner.Parent = titleBar

-- Fix für untere Ecken der Titelleiste
local titleFix = Instance.new("Frame")
titleFix.Size = UDim2.new(1, 0, 0, 12)
titleFix.Position = UDim2.new(0, 0, 1, -12)
titleFix.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
titleFix.BorderSizePixel = 0
titleFix.Parent = titleBar

-- Titel
local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, -70, 1, 0)
titleLabel.Position = UDim2.new(0, 10, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "ESP Menu v2.1"
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.TextSize = 16
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = titleBar

-- Minimieren Button
local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Size = UDim2.new(0, 25, 0, 25)
minimizeBtn.Position = UDim2.new(1, -60, 0, 5)
minimizeBtn.Text = "-"
minimizeBtn.Font = Enum.Font.GothamBold
minimizeBtn.TextSize = 20
minimizeBtn.BackgroundColor3 = Color3.fromRGB(255, 193, 7)
minimizeBtn.TextColor3 = Color3.fromRGB(0, 0, 0)
minimizeBtn.BorderSizePixel = 0
minimizeBtn.Parent = titleBar

local minCorner = Instance.new("UICorner")
minCorner.CornerRadius = UDim.new(0, 4)
minCorner.Parent = minimizeBtn

-- Schließen Button
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 25, 0, 25)
closeBtn.Position = UDim2.new(1, -30, 0, 5)
closeBtn.Text = "×"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 18
closeBtn.BackgroundColor3 = Color3.fromRGB(220, 53, 69)
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeBtn.BorderSizePixel = 0
closeBtn.Parent = titleBar

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 4)
closeCorner.Parent = closeBtn

-- Sidebar (Links)
local sidebar = Instance.new("Frame")
sidebar.Size = UDim2.new(0, 150, 1, -35)
sidebar.Position = UDim2.new(0, 0, 0, 35)
sidebar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
sidebar.BorderSizePixel = 0
sidebar.Parent = mainFrame

-- Content Area (Rechts)
local contentArea = Instance.new("Frame")
contentArea.Size = UDim2.new(1, -150, 1, -35)
contentArea.Position = UDim2.new(0, 150, 0, 35)
contentArea.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
contentArea.BorderSizePixel = 0
contentArea.Parent = mainFrame

-- Resize Handle
local resizeHandle = Instance.new("TextButton")
resizeHandle.Size = UDim2.new(0, 20, 0, 20)
resizeHandle.Position = UDim2.new(1, -20, 1, -20)
resizeHandle.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
resizeHandle.BorderSizePixel = 0
resizeHandle.Text = ""
resizeHandle.Parent = mainFrame

local resizeCorner = Instance.new("UICorner")
resizeCorner.CornerRadius = UDim.new(0, 4)
resizeCorner.Parent = resizeHandle

---------------------------
-- Funktionen & Variablen
---------------------------

-- Player Funktionen
local flying = false
local flySpeed = 50
local flyVelocity
local playerSpeed = 16

-- ESP Funktionen
local espEnabled = false
local nameEnabled = false
local espConnections = {}
local hitboxColor = Color3.fromRGB(255, 0, 0)
local nameColor = Color3.fromRGB(255, 255, 255)

-- Panels
local panels = {}
local currentPanel = nil

-- Keybind Settings
local toggleKey = Enum.KeyCode.F

-- Fly Toggle Funktion
local function toggleFly(state)
    if state then
        if not flyVelocity then
            local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if root then
                flyVelocity = Instance.new("BodyVelocity")
                flyVelocity.MaxForce = Vector3.new(1e5, 1e5, 1e5)
                flyVelocity.Velocity = Vector3.zero
                flyVelocity.Parent = root
            end
        end
        flying = true
    else
        flying = false
        if flyVelocity then 
            flyVelocity:Destroy() 
            flyVelocity = nil 
        end
    end
end

-- ESP Update Funktionen (Optimiert)
local lastESPUpdate = 0
local ESP_UPDATE_RATE = 0.1

local function updateESP(state)
    espEnabled = state
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character then
            local root = plr.Character:FindFirstChild("HumanoidRootPart")
            if root then
                if state then
                    if not root:FindFirstChild("HitboxESP") then
                        local box = Instance.new("BoxHandleAdornment")
                        box.Name = "HitboxESP"
                        box.Size = root.Size + Vector3.new(1, 3, 1)
                        box.Adornee = root
                        box.AlwaysOnTop = true
                        box.Transparency = 0.7
                        box.Color3 = hitboxColor
                        box.Parent = root
                    else
                        root.HitboxESP.Color3 = hitboxColor
                    end
                else
                    local esp = root:FindFirstChild("HitboxESP")
                    if esp then esp:Destroy() end
                end
            end
        end
    end
end

local function updateNames(state)
    nameEnabled = state
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild("Head") then
            local head = plr.Character.Head
            if state then
                if not head:FindFirstChild("NameESP") then
                    local billboard = Instance.new("BillboardGui")
                    billboard.Name = "NameESP"
                    billboard.Size = UDim2.new(0, 200, 0, 50)
                    billboard.Adornee = head
                    billboard.AlwaysOnTop = true
                    billboard.Parent = head
                    
                    local nameLabel = Instance.new("TextLabel")
                    nameLabel.Size = UDim2.new(1, 0, 1, 0)
                    nameLabel.BackgroundTransparency = 1
                    nameLabel.Text = plr.Name
                    nameLabel.Font = Enum.Font.GothamBold
                    nameLabel.TextColor3 = nameColor
                    nameLabel.TextScaled = true
                    nameLabel.TextStrokeTransparency = 0
                    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
                    nameLabel.Parent = billboard
                else
                    local nameLabel = head.NameESP:FindFirstChild("TextLabel")
                    if nameLabel then
                        nameLabel.TextColor3 = nameColor
                    end
                end
            else
                local nameESP = head:FindFirstChild("NameESP")
                if nameESP then nameESP:Destroy() end
            end
        end
    end
end

-- Notification Funktion
local function showNotification(title, message, duration)
    StarterGui:SetCore("SendNotification", {
        Title = title or "ESP Menu",
        Text = message or "",
        Duration = duration or 3
    })
end

-- UI Helper Funktionen
local function createButton(parent, text, position, size, callback)
    local button = Instance.new("TextButton")
    button.Size = size or UDim2.new(1, -20, 0, 30)
    button.Position = position or UDim2.new(0, 10, 0, 10)
    button.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    button.BorderSizePixel = 0
    button.Text = text
    button.Font = Enum.Font.Gotham
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextSize = 14
    button.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = button
    
    if callback then
        button.MouseButton1Click:Connect(callback)
    end
    
    return button
end

local function createSlider(parent, labelText, position, minVal, maxVal, currentVal, callback)
    local sliderFrame = Instance.new("Frame")
    sliderFrame.Size = UDim2.new(1, -20, 0, 60)
    sliderFrame.Position = position
    sliderFrame.BackgroundTransparency = 1
    sliderFrame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0, 20)
    label.Position = UDim2.new(0, 0, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = labelText .. ": " .. currentVal
    label.Font = Enum.Font.Gotham
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 12
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = sliderFrame
    
    local sliderBg = Instance.new("Frame")
    sliderBg.Size = UDim2.new(1, 0, 0, 20)
    sliderBg.Position = UDim2.new(0, 0, 0, 25)
    sliderBg.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    sliderBg.BorderSizePixel = 0
    sliderBg.Parent = sliderFrame
    
    local sliderCorner = Instance.new("UICorner")
    sliderCorner.CornerRadius = UDim.new(0, 10)
    sliderCorner.Parent = sliderBg
    
    local sliderFill = Instance.new("Frame")
    sliderFill.Size = UDim2.new((currentVal - minVal) / (maxVal - minVal), 0, 1, 0)
    sliderFill.Position = UDim2.new(0, 0, 0, 0)
    sliderFill.BackgroundColor3 = Color3.fromRGB(0, 162, 255)
    sliderFill.BorderSizePixel = 0
    sliderFill.Parent = sliderBg
    
    local fillCorner = Instance.new("UICorner")
    fillCorner.CornerRadius = UDim.new(0, 10)
    fillCorner.Parent = sliderFill
    
    local dragging = false
    
    sliderBg.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
        end
    end)
    
    sliderBg.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    UserInput.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local x = math.clamp(input.Position.X - sliderBg.AbsolutePosition.X, 0, sliderBg.AbsoluteSize.X)
            local ratio = x / sliderBg.AbsoluteSize.X
            local value = math.floor(minVal + ratio * (maxVal - minVal))
            
            sliderFill.Size = UDim2.new(ratio, 0, 1, 0)
            label.Text = labelText .. ": " .. value
            
            if callback then
                callback(value)
            end
        end
    end)
    
    return sliderFrame
end

local function createColorPicker(parent, labelText, position, currentColor, callback)
    local colorFrame = Instance.new("Frame")
    colorFrame.Size = UDim2.new(1, -20, 0, 80)
    colorFrame.Position = position
    colorFrame.BackgroundTransparency = 1
    colorFrame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0, 20)
    label.Position = UDim2.new(0, 0, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = labelText
    label.Font = Enum.Font.Gotham
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 12
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = colorFrame
    
    local colorPreview = Instance.new("Frame")
    colorPreview.Size = UDim2.new(0, 40, 0, 20)
    colorPreview.Position = UDim2.new(0, 0, 0, 25)
    colorPreview.BackgroundColor3 = currentColor
    colorPreview.BorderSizePixel = 1
    colorPreview.BorderColor3 = Color3.fromRGB(255, 255, 255)
    colorPreview.Parent = colorFrame
    
    local colorCorner = Instance.new("UICorner")
    colorCorner.CornerRadius = UDim.new(0, 4)
    colorCorner.Parent = colorPreview
    
    local colors = {
        {Color3.fromRGB(255, 0, 0), "Red"},
        {Color3.fromRGB(0, 255, 0), "Green"}, 
        {Color3.fromRGB(0, 0, 255), "Blue"},
        {Color3.fromRGB(255, 255, 0), "Yellow"},
        {Color3.fromRGB(255, 255, 255), "White"}
    }
    
    local btnY = 0
    for _, col in ipairs(colors) do
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0, 30, 0, 20)
        btn.Position = UDim2.new(0, btnY * 35 + 50, 0, 25)
        btn.BackgroundColor3 = col[1]
        btn.Text = ""
        btn.BorderSizePixel = 1
        btn.BorderColor3 = Color3.fromRGB(255, 255, 255)
        btn.Parent = colorFrame
        
        local btnCorner = Instance.new("UICorner")
        btnCorner.CornerRadius = UDim.new(0, 4)
        btnCorner.Parent = btn
        
        btn.MouseButton1Click:Connect(function()
            colorPreview.BackgroundColor3 = col[1]
            if callback then callback(col[1]) end
        end)
        
        btnY = btnY + 1
    end
end

---------------------------
-- Player Info Tab
---------------------------

local playerInfoPanel = Instance.new("ScrollingFrame")
playerInfoPanel.Size = UDim2.new(1,0,1,0)
playerInfoPanel.Position = UDim2.new(0,0,0,0)
playerInfoPanel.BackgroundTransparency = 1
playerInfoPanel.ScrollBarThickness = 6
playerInfoPanel.Visible = false
playerInfoPanel.Parent = contentArea
panels["PlayerInfo"] = playerInfoPanel

local searchBox = Instance.new("TextBox")
searchBox.Size = UDim2.new(1,-20,0,25)
searchBox.Position = UDim2.new(0,10,0,10)
searchBox.PlaceholderText = "Spielername eingeben..."
searchBox.Font = Enum.Font.Gotham
searchBox.TextSize = 14
searchBox.TextColor3 = Color3.fromRGB(255,255,255)
searchBox.BackgroundColor3 = Color3.fromRGB(40,40,40)
searchBox.BorderSizePixel = 0
searchBox.Parent = playerInfoPanel

local listFrame = Instance.new("ScrollingFrame")
listFrame.Size = UDim2.new(1,-20,0,200)
listFrame.Position = UDim2.new(0,10,0,45)
listFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
listFrame.BorderSizePixel = 0
listFrame.ScrollBarThickness = 6
listFrame.CanvasSize = UDim2.new(0,0,0,0)
listFrame.Parent = playerInfoPanel

local detailFrame = Instance.new("Frame")
detailFrame.Size = UDim2.new(1,-20,0,60)
detailFrame.Position = UDim2.new(0,10,0,260)
detailFrame.BackgroundColor3 = Color3.fromRGB(50,50,50)
detailFrame.BorderSizePixel = 0
detailFrame.Visible = false
detailFrame.Parent = playerInfoPanel

local detailText = Instance.new("TextLabel")
detailText.Size = UDim2.new(1,0,1,0)
detailText.BackgroundTransparency = 1
detailText.Text = ""
detailText.Font = Enum.Font.Gotham
detailText.TextColor3 = Color3.fromRGB(255,255,255)
detailText.TextSize = 14
detailText.TextXAlignment = Enum.TextXAlignment.Left
detailText.TextYAlignment = Enum.TextYAlignment.Top
detailText.Parent = detailFrame

local function updatePlayerList()
    for _,v in ipairs(listFrame:GetChildren()) do
        if v:IsA("TextButton") then v:Destroy() end
    end
    local y = 0
    local search = searchBox.Text:lower()
    for _,plr in ipairs(Players:GetPlayers()) do
        if plr.Name:lower():find(search) then
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(1,0,0,25)
            btn.Position = UDim2.new(0,0,0,y)
            btn.BackgroundColor3 = Color3.fromRGB(70,70,70)
            btn.BorderSizePixel = 0
            btn.Text = plr.Name
            btn.Font = Enum.Font.Gotham
            btn.TextColor3 = Color3.fromRGB(255,255,255)
            btn.TextSize = 14
            btn.Parent = listFrame
            y = y + 30

            btn.MouseButton1Click:Connect(function()
                detailText.Text = "Name: "..plr.Name..
                                   "\nUserId: "..plr.UserId..
                                   "\nDummy Password: ••••••••"
                detailFrame.Visible = true
            end)
        end
    end
    listFrame.CanvasSize = UDim2.new(0,0,0,y)
end

searchBox.Changed:Connect(updatePlayerList)
updatePlayerList()
